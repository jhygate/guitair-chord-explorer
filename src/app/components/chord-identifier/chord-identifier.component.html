<div class="chord-identifier">
  @if (selectedPositions.length === 0) {
    <div class="text-center text-gray-400 py-8">
      <p class="text-sm">Click notes on the fretboard to identify chords</p>
    </div>
  } @else if (chordMatches.length === 0) {
    <div class="text-center text-gray-400 py-8">
      <p class="text-sm">No matching chords found</p>
      <p class="text-xs mt-2">Try selecting more notes</p>
    </div>
  } @else {
    <div class="space-y-3">
      <div class="flex items-center justify-between mb-2">
        <h4 class="text-sm font-medium text-gray-700">
          Possible Chords ({{ chordMatches.length }} found)
        </h4>
        @if (chordMatches.length > 5) {
          <button
            (click)="showTopFive = !showTopFive"
            class="text-xs text-blue-600 hover:text-blue-800">
            {{ showTopFive ? 'Show all' : 'Show top 5' }}
          </button>
        }
      </div>

      @for (match of getDisplayMatches(); track $index) {
        <div
          class="chord-match border rounded-lg p-3 cursor-pointer transition-all"
          [class.ring-2]="selectedMatch === match"
          [class.ring-blue-500]="selectedMatch === match"
          (click)="onChordClick(match)">

          <!-- Chord Name and Confidence -->
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-lg font-bold text-gray-900">
                {{ match.chord.displayName }}
              </span>
              <span class="text-xs px-2 py-1 rounded-full" [ngClass]="getConfidenceClass(match.confidence)">
                {{ getConfidenceLabel(match.confidence) }}
              </span>
            </div>
            <span class="text-xs text-gray-500">
              {{ (match.confidence * 100).toFixed(0) }}% match
            </span>
          </div>

          <!-- Keys Information (collapsed) -->
          @if (match.appearsInKeys.length > 0) {
            <div class="text-xs text-gray-600">
              Found in {{ match.appearsInKeys.length }} key{{ match.appearsInKeys.length > 1 ? 's' : '' }}
            </div>
          }

          <!-- Expanded Details -->
          @if (selectedMatch === match) {
            <div class="mt-3 pt-3 border-t border-gray-200 space-y-3">

              <!-- Chord Notes -->
              <div>
                <p class="text-xs font-medium text-gray-700 mb-1">Chord Notes:</p>
                <div class="flex flex-wrap gap-1">
                  @for (note of match.chord.notes; track $index) {
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                      {{ note.pitch }}{{ note.accidental }}
                    </span>
                  }
                </div>
              </div>

              <!-- Missing Notes -->
              @if (match.missingNotes.length > 0) {
                <div>
                  <p class="text-xs font-medium text-gray-700 mb-1">Missing Notes:</p>
                  <div class="flex flex-wrap gap-1">
                    @for (note of match.missingNotes; track $index) {
                      <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">
                        {{ note.pitch }}{{ note.accidental }}
                      </span>
                    }
                  </div>
                </div>
              }

              <!-- Extra Notes -->
              @if (match.extraNotes.length > 0) {
                <div>
                  <p class="text-xs font-medium text-gray-700 mb-1">Extra Notes (not in chord):</p>
                  <div class="flex flex-wrap gap-1">
                    @for (note of match.extraNotes; track $index) {
                      <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs">
                        {{ note.pitch }}{{ note.accidental }}
                      </span>
                    }
                  </div>
                </div>
              }

              <!-- Appears in Keys -->
              @if (match.appearsInKeys.length > 0) {
                <div>
                  <p class="text-xs font-medium text-gray-700 mb-1">Appears in these keys:</p>
                  <div class="grid grid-cols-2 gap-2">
                    @for (keyInfo of match.appearsInKeys; track $index) {
                      <div class="text-xs bg-gray-50 rounded p-2">
                        <span class="font-medium">
                          {{ keyInfo.key.pitch }}{{ keyInfo.key.accidental }} {{ keyInfo.scaleType }}
                        </span>
                        <span class="text-gray-600 ml-1">({{ keyInfo.romanNumeral }})</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  }
</div>
