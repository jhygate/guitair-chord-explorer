<div class="fretboard-container">
  <!-- Controls -->
  <div class="flex items-center justify-between mb-3">
    <div class="text-sm font-medium text-gray-700">
      Position: {{ getPositionLabel() }}
    </div>
    <div class="flex gap-2">
      <button
        (click)="toggleScaleDegrees()"
        class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs font-medium"
        title="Toggle between scale degrees and note names">
        {{ showScaleDegrees ? 'Show Notes' : 'Show Degrees' }}
      </button>
      <button
        (click)="moveUp()"
        [disabled]="fretStart === 0"
        class="px-2 py-1 bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 rounded text-xs font-medium">
        ← Lower
      </button>
      <button
        (click)="moveDown()"
        [disabled]="fretEnd >= 24"
        class="px-2 py-1 bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 rounded text-xs font-medium">
        Higher →
      </button>
    </div>
  </div>

  <!-- Fretboard (Horizontal) -->
  <div class="fretboard-wrapper">
    <!-- The actual fretboard -->
    <svg class="fretboard-svg" [attr.viewBox]="getViewBox()" preserveAspectRatio="xMinYMid meet">
      <!-- Background -->
      <rect x="0" y="0" [attr.width]="getViewBoxWidth()" height="180" fill="#8B4513" opacity="0.3"/>

      <!-- Fret lines (vertical) -->
      @for (fret of frets; track fret; let i = $index) {
        <!-- Skip drawing fret 0 - the nut represents it -->
        @if (fret !== 0) {
          <line [attr.x1]="fretStart === 0 ? (80 + (fret * 80)) : (80 + ((fret - fretStart + 1) * 80))"
                [attr.y1]="20"
                [attr.x2]="fretStart === 0 ? (80 + (fret * 80)) : (80 + ((fret - fretStart + 1) * 80))"
                [attr.y2]="160"
                stroke="#666"
                stroke-width="2"/>
        }
      }

      <!-- End fret line -->
      <line [attr.x1]="fretStart === 0 ? (80 + (fretEnd * 80) + 80) : (80 + ((fretEnd - fretStart + 1) * 80) + 80)"
            y1="20"
            [attr.x2]="fretStart === 0 ? (80 + (fretEnd * 80) + 80) : (80 + ((fretEnd - fretStart + 1) * 80) + 80)"
            y2="160"
            stroke="#666"
            stroke-width="3"/>

      <!-- Nut (if showing open position) -->
      @if (fretStart === 0) {
        <line x1="80"
              y1="20"
              x2="80"
              y2="160"
              stroke="#333"
              stroke-width="4"/>
      }

      <!-- String lines (horizontal) -->
      @for (stringData of strings; track stringData.string; let i = $index) {
        <g>
          <line [attr.x1]="80"
                [attr.y1]="30 + (i * 25)"
                [attr.x2]="fretStart === 0 ? (80 + ((frets.length) * 80)) : (80 + ((frets.length + 1) * 80))"
                [attr.y2]="30 + (i * 25)"
                stroke="#333"
                [attr.stroke-width]="1 + (6 - i) * 0.3"
                [attr.opacity]="isStringMuted(stringData.string) ? '0.5' : '1'"/>

          <!-- Mute/Play marker (X or O) on far left -->
          <g class="string-marker">
            <!-- Invisible clickable hitbox -->
            <rect [attr.x]="0"
                  [attr.y]="18 + (i * 25)"
                  width="30"
                  height="24"
                  fill="transparent"
                  class="clickable"
                  (click)="onStringDoubleClick(stringData.string)"/>

            <!-- X for muted -->
            @if (isStringMuted(stringData.string)) {
              <text [attr.x]="15"
                    [attr.y]="35 + (i * 25)"
                    text-anchor="middle"
                    font-size="16"
                    fill="#dc3545"
                    font-weight="bold"
                    pointer-events="none">
                ✕
              </text>
            }
            <!-- O for open/played -->
            @if (!isStringMuted(stringData.string)) {
              <circle [attr.cx]="15"
                      [attr.cy]="30 + (i * 25)"
                      r="8"
                      fill="none"
                      stroke="#28a745"
                      stroke-width="2"
                      pointer-events="none"/>
            }
          </g>

          <!-- String note name label -->
          <text [attr.x]="50"
                [attr.y]="35 + (i * 25)"
                text-anchor="middle"
                font-size="12"
                [attr.fill]="isStringMuted(stringData.string) ? '#999' : '#333'"
                font-weight="600"
                class="string-label-text">
            {{ getStringNoteName(stringData.string) }}
          </text>
        </g>
      }

      <!-- Fret numbers -->
      @for (fret of frets; track fret; let i = $index) {
        @if (fret !== 0) {
          <text [attr.x]="fretStart === 0 ? (40 + (fret * 80)) : (120 + ((fret - fretStart) * 80))"
                y="15"
                text-anchor="middle"
                font-size="10"
                fill="#666">
            {{ fret }}
          </text>
        }
      }

      <!-- Note interaction and rendering -->
      @for (stringData of strings; track stringData.string; let stringIdx = $index) {
        <g>
          <!-- LAYER 1: Clickable hitboxes (drawn first, below everything) -->
          @for (position of stringData.positions; track position.fret) {
            @if (!isStringMuted(stringData.string)) {
              @if (position.fret === 0) {
                <!-- Open string: larger clickable area near the nut -->
                <rect [attr.x]="60"
                      [attr.y]="30 + (stringIdx * 25) - 15"
                      width="40"
                      height="30"
                      fill="transparent"
                      class="clickable"
                      (click)="onPositionClick(position)"/>
              } @else {
                <!-- Fretted note: clickable area spanning the fret space -->
                <rect [attr.x]="fretStart === 0 ? ((position.fret * 80)) : (80 + ((position.fret - fretStart) * 80))"
                      [attr.y]="30 + (stringIdx * 25) - 15"
                      width="80"
                      height="30"
                      fill="transparent"
                      class="clickable"
                      (click)="onPositionClick(position)"/>
              }
            }
          }

          <!-- LAYER 2: Visual representations (drawn on top of hitboxes) -->
          @for (position of stringData.positions; track position.fret) {
            <g>
              <!-- SELECTED NOTES -->
              @if (isPositionSelected(position)) {
                @if (position.fret === 0) {
                  <!-- Selected open string: ring style -->
                  <circle [attr.cx]="80"
                          [attr.cy]="30 + (stringIdx * 25)"
                          r="11"
                          fill="none"
                          [attr.stroke]="position.isInChord ? '#2196f3' : '#f44336'"
                          stroke-width="3"
                          [attr.opacity]="isStringMuted(stringData.string) ? '0.5' : '1'"
                          pointer-events="none"/>
                  <text [attr.x]="80"
                        [attr.y]="34 + (stringIdx * 25)"
                        text-anchor="middle"
                        font-size="9"
                        [attr.fill]="position.isInChord ? '#2196f3' : '#f44336'"
                        font-weight="bold"
                        [attr.opacity]="isStringMuted(stringData.string) ? '0.5' : '1'"
                        pointer-events="none">
                    {{ getNoteDisplay(position) }}
                  </text>
                } @else {
                  <!-- Selected fretted note: filled circle -->
                  <circle [attr.cx]="fretStart === 0 ? (40 + (position.fret * 80)) : (120 + ((position.fret - fretStart) * 80))"
                          [attr.cy]="30 + (stringIdx * 25)"
                          r="10"
                          [attr.fill]="position.isInChord ? '#2196f3' : '#f44336'"
                          stroke="#fff"
                          stroke-width="2"
                          [attr.opacity]="isStringMuted(stringData.string) ? '0.5' : '1'"
                          pointer-events="none"/>
                  <text [attr.x]="fretStart === 0 ? (40 + (position.fret * 80)) : (120 + ((position.fret - fretStart) * 80))"
                        [attr.y]="34 + (stringIdx * 25)"
                        text-anchor="middle"
                        font-size="9"
                        fill="#fff"
                        font-weight="bold"
                        [attr.opacity]="isStringMuted(stringData.string) ? '0.5' : '1'"
                        pointer-events="none">
                    {{ getNoteDisplay(position) }}
                  </text>
                }
              } @else if (position.isInChord && !isStringMuted(stringData.string)) {
                <!-- GHOST NOTES (unselected chord tones) -->
                @if (position.fret === 0) {
                  <!-- Ghost open string: thin ring -->
                  <circle [attr.cx]="80"
                          [attr.cy]="30 + (stringIdx * 25)"
                          r="9"
                          fill="none"
                          [attr.stroke]="position.isRoot ? '#ffc107' : '#90caf9'"
                          stroke-width="2.5"
                          opacity="0.5"
                          pointer-events="none"/>
                  @if (showScaleDegrees && position.scaleDegree) {
                    <text [attr.x]="80"
                          [attr.y]="34 + (stringIdx * 25)"
                          text-anchor="middle"
                          font-size="8"
                          [attr.fill]="position.isRoot ? '#ffc107' : '#90caf9'"
                          opacity="0.6"
                          font-weight="600"
                          pointer-events="none">
                      {{ position.scaleDegree }}
                    </text>
                  } @else if (!showScaleDegrees) {
                    <text [attr.x]="80"
                          [attr.y]="34 + (stringIdx * 25)"
                          text-anchor="middle"
                          font-size="7"
                          [attr.fill]="position.isRoot ? '#ffc107' : '#90caf9'"
                          opacity="0.6"
                          font-weight="600"
                          pointer-events="none">
                      {{ getNoteDisplay(position) }}
                    </text>
                  }
                } @else {
                  <!-- Ghost fretted note: semi-transparent filled circle -->
                  <circle [attr.cx]="fretStart === 0 ? (40 + (position.fret * 80)) : (120 + ((position.fret - fretStart) * 80))"
                          [attr.cy]="30 + (stringIdx * 25)"
                          r="8"
                          [attr.fill]="position.isRoot ? '#ffc107' : '#90caf9'"
                          opacity="0.4"
                          pointer-events="none"/>
                  @if (showScaleDegrees && position.scaleDegree) {
                    <text [attr.x]="fretStart === 0 ? (40 + (position.fret * 80)) : (120 + ((position.fret - fretStart) * 80))"
                          [attr.y]="34 + (stringIdx * 25)"
                          text-anchor="middle"
                          font-size="8"
                          fill="#333"
                          opacity="0.6"
                          font-weight="600"
                          pointer-events="none">
                      {{ position.scaleDegree }}
                    </text>
                  } @else if (!showScaleDegrees) {
                    <text [attr.x]="fretStart === 0 ? (40 + (position.fret * 80)) : (120 + ((position.fret - fretStart) * 80))"
                          [attr.y]="34 + (stringIdx * 25)"
                          text-anchor="middle"
                          font-size="7"
                          fill="#333"
                          opacity="0.6"
                          font-weight="600"
                          pointer-events="none">
                      {{ getNoteDisplay(position) }}
                    </text>
                  }
                }
              }
              <!-- EMPTY POSITIONS: no visual needed, hitbox handles clicks -->
            </g>
          }
        </g>
      }
    </svg>
  </div>

  <!-- Instructions -->
  <div class="mt-2 text-xs text-gray-500">
    <p>Click position to select • Click X/O to mute/unmute string</p>
  </div>
</div>
